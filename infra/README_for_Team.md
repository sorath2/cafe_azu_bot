# Бот для кафе татарской кухни "АЗУ"

## Содержание
1. [БРИФ (основная информация)](#brif)
2. [Работа с репозиторием GitHub](#gitwork)
3. [Подготовка переменных окружения на GitHub](#git_hub)
4. [Работа с виртуальным окружением](#virtualenv)
5. [Используемый стек технологий](#stack)
6. [Структуре проекта](#project_struct)


# 1. БРИФ (Основная информация) <a id='brif'></a>

### Заказчик
Кафе татарской кухни "АЗУ" [azu.cafe](http://azu.cafe/)

### Цель проекта
Автоматизация процесс записи и резервирования места на 
время ифтара в месяц Рамадан (1 месяц в году, когда мусульманское население 
Казани держит пост до заката солнца)

### Реализация проекта
Чат бот для Telegram

### Что должен делать чат-бот
Чат-бот должен предоставить клиенту бронирования места в одном из кафе:
1. Выбрать дату
2. Выбрать адрес кафе 
3. Выбрать ифтар сет (1 из 9 вариантов комбо-набора) 
4. Оплатить сет дистанционно
5. Получить подтверждение о том, что на такое-то число забронировано и 
   оплачен ифтар сет номер Х по такому-то адресу
6. Отправить напоминание за 1 день до времени ифтара о том, что кафе АZU 
   ждет клиента по такому-то адресу в такое-то время
7. Номера телефонов различных филиалов для связи с администратором для 
   решения каких-либо специфических вопросов и пожеланий или брони зала под
   коллективный ифтар

# 2. Работа с репозиторием GitHub <a id='gitwork'></a>

1. В репозитории две основные ветки
   - `master` - основная **неприкосновенная** ветка. Здесь находится код, 
     готовый для продакшина. ⛔️Что либо комитить в эту ветку запрещено⛔️.
   - `develop` - пред-релизная ветка. Здесь выверенный и рабочий код.
   - `release_0_0_1` - код, созданный 1ой командой проекта
   - `release_0_0_2` - код, созданный 2ой командой проекта
   - `release_0_0_3` - код, созданный 3ей командой проекта **Финальный**.
2. Ветки для дальнейшей доработки проекта наследуем от `develop`
3. При комите кода в ветку `master` происходит автоматический деплой на сервер.
4. Правила именования веток:
   - ветки для нового функционала - `feature_<название функционала>`
   - ветки для исправления ошибок - `bug_fix_<название багфикса>` 
5. ‼️ Все комиты **в обязательном порядке** делаются 
   через *pull request-ы* ‼️
6. ‼️ **В остальные ветки НИЧЕГО не комитим.** ‼️
7. ‼️ **Важно:** если работаете на Windows перед клонированием репозитория 
   проверьте, что у `git` параметр `core.autocrlf` установлен в `true` 
   (команда `git config core.autocrlf true` для локальной настройки, `git 
   config --global core.autocrlf true` для глобальной настройки)

# 3. Подготовка переменных окружения на GitHub <a id='git_hub'></a>

Для автоматического развертывания бота в репозитории на [GitHub](https://github.com/) необходимо задать следующие секретные переменые (`Settings` - `Secrets and variables` - `Actions`):

- Настройки для работы бота:
  - `BOT_TOKEN` - токен для подключения к боту. Получается через [BotFather](https://t.me/BotFather)
  - `BOT_ADDRESS` - адрес бота (в формате https://t.me/<имя бота>)
  - `PAYMENT_TIMEOUT` - время ожидания оплаты, в минутах
- Настройки для работы панели администратора:
  - `ALOWED_HOSTS` - список хостов, на которых может запускаться проект. В обазятельном порядке указываются `django` и IP или доменное имя хоста, на котором развернут сервер. Хосты указываются через запятую, без http  и портов
  - `CSRF_TRUSTED_ORIGINS` - список доверенных хостов, с которых могут приходить запросф. В обазятельном порядке указываются `django` и IP или доменное имя хоста, на котором развернут сервер. Хосты указываются через запятую, с указанием протокола (http://, https://)  и порта. 
  - `SECRET_KEY` - буквенно-цифровая последовательность для шифрования (буквы - английские)
  - `ENGINE` - механизм, который используется для поключения к БД. В данном проекте должно быть равно `django.db.backends.postgresql`
  - `DEBUG` - если указано `True`, то при ошибках выводится отладочная информация, если `False` - выводится просто ошибка сервера
- Настройки для подключения к БД:
  - `POSTGRES_DB` - имя БД
  - `POSTGRES_HOST` - хост, на котором располагается БД. В данном проекте - `postgres`
  - `POSTGRES_PORT` - порт подключения к БД. В данном проекте - `5432`
  - `POSTGRES_USER` - имя пользователя для подключения к БД
  - `POSTGRES_PASSWORD` - пароль для подключения к БД
- Настройки для работы с [Робокассой](https://robokassa.com):
  - `MERCHANT_LOGIN` - идентификатор магазина
  - `MERCHANT_PASSWORD1` - пароль #1 из технических настроек магазина
  - `MERCHANT_PASSWORD2` - пароль #2 из технических настроек магазина
  - `TEST_MODE` - `True`, если оплата проводится в тестовом режиме, `False`- в противном случае.
- Настройки для подключения к [DockerHub](https://hub.docker.com/):
  - `DOCKER_USERNAME` - имя пользователя для подключения к [DockerHub](https://hub.docker.com/)
  - `DOCKER_PASSWORD` - пароль для подключения к [DockerHub](https://hub.docker.com/)
- Настройки для подключения к серверу, на котором развертывается бот, по SSH:
  - `SSH_HOST` - IP адрес или доменное имя сервера
  - `SSH_KEY` - SSH ключ (закрытый) для подключения к серверу. Открытый ключ должен быть размещен на  сервере
  - `SSH_PHRASE` - пароль для SSH ключа
  - `SSH_USER` - имя пользователя для подключения к серверу

# 4. Работа с виртуальным окружением <a id='virtualenv'></a>
Poetry - это инструмент для управления зависимостями и виртуальными 
окружениями. Его преимущество, что можно разделить зависимости, 
используемые только для разработки (например, применение стилей, тесты), от 
зависимостей, которые необходимы проекту для работы на продакшене.

### Установка:

Инструкции по установке расположены на [официальном сайте](https://python-poetry.org/docs/#installation).

**Команды для установки:**
 
Для UNIX-систем и Bash on Windows вводим в консоль следующую команду:
```
curl -sSL https://install.python-poetry.org | python -
```

Для WINDOWS PowerShell:
```PowerShell
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
```

После установки, если установщик попросит, добавить путь к poetry в 
переменную среды `PATH`, перезапустить оболочку и выполнить команду

```
poetry --version
```

Если установка прошла успешно, будет выведена версия poetry (может отличаться)

> Poetry (version 1.6.1)

Что бы виртуальное окружение устанавливалось в папку проекта выполнить команду:

```
poetry config virtualenvs.in-project true
```

В корневой папке проекта виртуальное окружение создается с помощью команды:

```
poetry install
```

Результатом выполнения команды станет создание в корне проекта папки `.venv`.
Зависимости для создания окружения берутся из файлов poetry.lock (приоритетнее)
и pyproject.toml

<details>
<summary>
Добавление зависимостей
</summary>
Для добавления новой зависимости в окружение необходимо выполнить команду

```
poetry add <package_name>
```

_Пример:_ `poetry add flake8`

Для добавления зависимости необходимой для разработки и тестирования необходимо
добавить флаг **--group dev**

```
poetry add <package_name> --group dev
```

_Пример:_ `poetry add pytest --group dev`

</details>

### Версия python <a id='python_version'></a>

В проекте используется питон версии 3.10. Если при установке виртуального 
окружения poetry ругается, что не может определить локальную версию:
1. Проверьте, что на компьютере установлена версия Python 3.10
2. Явно указать poetry какую версию питона использовать для создания ВО 
   `poetry env use <полный путь к исполняемому файлу python версии 3.10>`

### Запуск скриптов

Запуск скриптов с использованием poetry возможен как с активацией 
виртуального окружения, так и без него.

Запуск осуществляется командой
```
poetry run <имя скрипта>.py
```

Активировать окружение можно командой

```
poetry shell
```

В этом случае скрипты можно запускать традиционным способом
```
python <имя скрипта>.py
```

Стандартный метод активацией окружения остается доступен:

Для WINDOWS:
```
source .venv/Scripts/activate
```

Для UNIX:
```
source .venv/bin/activate
```

Подробнее про команды poetry рассказано в [документации](https://python-poetry.org/docs/cli/)


# 5. Используемый стек технологий <a id='stack'></a>

### Для разработки
- Python 3.10
- Для бота
  - asyncpg 0.28.0
  - sqlalchemy 1.4.50
  - pydantic 2.4.2
  - pydantic-settings 2.0.3
  - alembic 1.12.1
  - python-dotenv 1.0.0
  - python-telegram-bot[job-queue] 20.7
  - python-telegram-bot-calendar 1.0.5
- Для администраторской панели
  - django 4.2.7
  - python-dotenv 1.0.0
  - psycopg2-binary 2.9.5
  - gunicorn 21.2.0
  - pillow 10.1.0

### Для стилистики
_Указаны минимальные версии. По факту может отличаться в большую сторону_
- black 23.10.1
- isort 5.12.0 
- flake8 6.1.0
- pep8-naming 0.13.3
- flake8-broken-line 1.0.0
- flake8-return 1.2.0
- flake8-isort 6.1.0


# 6. Структуре проекта: <a id='project_struct'></a>

```
cafe_azu_bot_1
├── .github                 Файлы для Github actions
├── admin_panel             Администраторская панель
│   ├── admin_panel         Настроечные файлы
│   ├── azucafe             Файлы для работы администраторской панели
│   ├── .dockerignore       Что игнорировать
│   ├── base_data.json      Файл с тестовыми данными
│   ├── dep.sh              Файл для донастройки контейнера Docker
│   ├── Dockerfile          Файл сборки образа Docker
│   ├── manage.py           Основной файл управления джангой
│   ├── poetry.lock         Файл с зависимостями для poetry
│   ├── pyproject.toml      Файл с зависимостями для poetry
│   └── README.md           
├── bot                     Основной код проекта
│   ├── alembic             Миграции для БД
│   ├── core                Базовые файлы бота
│   ├── crud                Операции для работы с БД
│   ├── media               Медия файлы для работы с тестовыми данными
│   ├── models              Модели для работы с БД
│   ├── modules             Модули, в которых реализован функционал бота
│   ├── .dockerignore       Что игнорировать
│   ├── .gitignore          Что игнорировать
│   ├── alembic.ini         Настройки alembic
│   ├── dep.sh              Файл для донастройки контейнера Docker
│   ├── Dockerfile          Файл сборки образа Docker
│   ├── main.py             Основной файл бота
│   ├── Makefile            Файл для запуска процесса приведения к единому стилю 
│   ├── poetry.lock         Файл с зависимостями для poetry
│   ├── pyproject.toml      Файл с зависимостями для poetry
│   └── setup.cfg           Настройки для стилистики
├── .gitignore              Что игнорировать
├── README.md               Здесь будет описание проекта, установка и т.д.
└── README_for_Team.md      Это сейчас читаем
```

В ходе работы над проектом структура может претерпевать изменения.

**ВАЖНО**
Файлы `pyproject.toml` (и соответственно `poetry.lock`), `setup.cfg`, 
`Makefile`, `.gitignore` обновляет **только тимлид**
